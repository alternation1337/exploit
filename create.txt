<?php
// Start the session
session_start();

// Include the config.php file
require_once 'config.php';

// Error reporting
error_reporting(E_ALL);
ini_set('display_errors', 1);

// Check if the user is logged in
if (!isset($_SESSION['email'])) {
    header("Location: ../login.php");
    exit();
}

// Retrieve the user's information
$email = $_SESSION['email'];

// Fetch the user's information from the database
$query = "SELECT id, first_name, last_name FROM users WHERE email = ?";
$stmt = mysqli_prepare($connection, $query);
mysqli_stmt_bind_param($stmt, "s", $email);
mysqli_stmt_execute($stmt);
mysqli_stmt_bind_result($stmt, $userId, $first_name, $last_name);
mysqli_stmt_fetch($stmt);
mysqli_stmt_close($stmt);

// Retrieve the session variables from deposit.php
$email = $_SESSION['email'] ?? '';
$amount = $_SESSION['amount'] ?? '';
$paymentMethod = $_SESSION['paymentMethod'] ?? '';

// Clear the session variables from deposit.php (optional)
unset($_SESSION['amount']);
unset($_SESSION['paymentMethod']);

// Store the deposit information in the session
$_SESSION['email'];
$_SESSION['userId'] = $userId;
$_SESSION['amount'] = $amount;
$_SESSION['paymentMethod'] = $paymentMethod;


// Define wallet addresses for each payment method
$walletAddresses = [
    'bitcoin' => 'bc1qd06d9s092lq60zjn0vfxcuxprdaamupz7m6e79',
    'ethereum' => '0xdDA99D56AB2D103f1f4568c2110aB3E1089898e2',
    'bnb' => '0xdDA99D56AB2D103f1f4568c2110aB3E1089898e2',
    'bsc' => '0xdDA99D56AB2D103f1f4568c2110aB3E1089898e2',
    'tron' => 'TDy2st3ARvffEp5TzWuuTf81pbbY5oWFeZ',
    'usdt' => 'TDy2st3ARvffEp5TzWuuTf81pbbY5oWFeZ'
];

// Define barcode images for each payment method
$barcodeImages = [
    'bitcoin' => 'bc1qd06d9s092lq60zjn0vfxcuxprdaamupz7m6e79',
    'ethereum' => '0xdDA99D56AB2D103f1f4568c2110aB3E1089898e2',
    'bnb' => '0xdDA99D56AB2D103f1f4568c2110aB3E1089898e2',
    'bsc' => '0xdDA99D56AB2D103f1f4568c2110aB3E1089898e2',
    'tron' => 'TDy2st3ARvffEp5TzWuuTf81pbbY5oWFeZ',
    'usdt' => 'TDy2st3ARvffEp5TzWuuTf81pbbY5oWFeZ'
];

// Function to fetch exchange rate from CoinGecko API
function calculateConvertedAmount($amount, $paymentMethod)
{
    // Fetch real-time exchange rate from CoinGecko API
    $url = 'https://api.coingecko.com/api/v3/simple/price?ids=' . $paymentMethod . '&vs_currencies=usd';
    $data = file_get_contents($url);
    $exchangeRates = json_decode($data, true);

    // Check if the API response contains the exchange rate for the specified payment method
    if (isset($exchangeRates[$paymentMethod]['usd'])) {
        $exchangeRate = $exchangeRates[$paymentMethod]['usd'];
        $convertedAmount = $amount / $exchangeRate;
        return number_format($convertedAmount, 7); // Format to display 7 decimal places
    } else {
        return 'Invalid payment method';
    }
}

// Calculate the converted amount (using real-time exchange rates)
$convertedAmount = calculateConvertedAmount($amount, $paymentMethod);

// Get the wallet address based on the selected payment method
$walletAddress = $walletAddresses[$paymentMethod] ?? 'Wallet address not available';
$barcodeImage = $barcodeImages[$paymentMethod] ?? '/barcode';
?>


<!DOCTYPE html>
<html lang="en" style="--hover: #dce2e4; --background-colour: #f5f7fe; --background-font-colour: #4a4a4a; --background-heading-colour: #000000; --primary-background: #ffffff; --primary-font-colour: #02194A; --primary-border-colour: #dbdcdf; --primary-link-colour: #000000; --secondary-background: #090E17; --secondary-font-colour: #a5bdd9; --secondary-heading-colour: #ffffff; --border-colour: #f2f2f2; --image: url('/assets/images/Background8.jpg'); height: 100%;">
    <head>
    <meta charset="UTF-8">
    <title>Deposit_step2 - Prime Global Cryptox</title>
    
    <meta content="width=device-width, user-scalable=no" name="viewport">
    <meta content="Trade Stocks, Forex, and Crypto Currencies, Start making profit today by trading over 150 Stocks, Forex and Crypto Currencies." property="og:description">

    <link href="/assets/css/reactapp-modules.css" rel="stylesheet">
    <link href="/assets/css/flag-icon-css/css/flag-icon.min.css" rel="stylesheet">

    
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="/assets/css/reactapp.css" rel="stylesheet">
  <link rel="manifest" href="/manifest.json" crossorigin="use-credentials">
  <link type="text/css" rel="stylesheet" charset="UTF-8" href="https://www.gstatic.com/_/translate_http/_/ss/k=translate_http.tr.69JJaQ5G5xA.L.W.O/d=0/rs=AN8SPfpC36MIoWPngdVwZ4RUzeJYZaC7rg/m=el_main_css">
  
  <!-- Materialize CSS -->
<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

<!-- Materialize JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <!--<script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/_/translate_http/_/js/k=translate_http.tr.en_US.LQ0KA1Zq4M4.O/d=1/exm=el_conf/ed=1/rs=AN8SPfrAAQJTFwK3rtGIz2g8pqiWIkizXg/m=el_main"></script> -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    var sideNavElems = document.querySelectorAll('.sidenav');
    M.Sidenav.init(sideNavElems);
  });
</script>
  
  </head>

 
<body data-new-gr-c-s-check-loaded="14.1113.0" data-gr-ext-installed="" style="position: relative; min-height: 100%; top: 0px;" class="">
    <noscript> You need to enable JavaScript to run this app. </noscript>

    <div id="root"><div class="navbar-fixed">
        
        <nav class="bg">
            <div class="nav-wrapper"><ul id="nav-mobile" class="left"><li><a data-target="mobile-demo" class="sidenav-trigger show-on-large "><span class="material-icons notranslate">menu</span></a></li><li><a href="/user/index.html"><b class="app-title">Prime Global Cryptox</b></a></li></ul>
        
        <ul class="right hide-on-med-and-down"><li class="dropdown-trigger" data-target="translator"><a class=""><span class="flag-icon flag-icon-us flag-icon-rounded "></span> <span class="hide-on-small-only">en</span></a></li><ul id="translator" class="dropdown-content" tabindex="0"><li tabindex="0"><a id="en"><span class="flag-icon flag-icon-us flag-icon-rounded"></span> English</a></li><li tabindex="0"><a id="vi"><span class="flag-icon flag-icon-vi flag-icon-rounded"></span> Vietnamese</a></li><li tabindex="0"><a id="pt"><span class="flag-icon flag-icon-pt flag-icon-rounded"></span> Portugues</a></li><li tabindex="0"><a id="zh-CN"><span class="flag-icon flag-icon-cn flag-icon-rounded"></span> Chinese</a></li><li tabindex="0"><a id="it"><span class="flag-icon flag-icon-it flag-icon-rounded"></span> Italiano</a></li><li tabindex="0"><a id="es"><span class="flag-icon flag-icon-es flag-icon-rounded"></span> Espanol</a></li><li tabindex="0"><a id="tr"><span class="flag-icon flag-icon-tr flag-icon-rounded"></span> Turkce</a></li><li tabindex="0"><a id="fr"><span class="flag-icon flag-icon-fr flag-icon-rounded"></span> French</a></li><li tabindex="0"><a id="de"><span class="flag-icon flag-icon-de flag-icon-rounded"></span> German</a></li><li tabindex="0"><a id="ja"><span class="flag-icon flag-icon-jp flag-icon-rounded"></span> Japanese</a></li><li tabindex="0"><a id="se"><span class="flag-icon flag-icon-se flag-icon-rounded"></span> Svenska</a></li><li tabindex="0"><a id="id"><span class="flag-icon flag-icon-id flag-icon-rounded"></span> Indonesia</a></li></ul>
        
        <li><img src="/uploads/images/camera.png" class="circle" style="height: 45px;"></li><li><a href="settings.php"><?php echo $first_name . ' ' . $last_name; ?></a></li><li data-target="themer" class="dropdown-trigger hide-on-med-and-down"><a class="">Theme</a></li><ul id="themer" class="dropdown-content" tabindex="0" style=""><li tabindex="0"><a id="en">LIGHT</a></li><li tabindex="0"><a id="en">DARK</a></li></ul>
        
        <li id="signin material-icons notranslate"><a title="Sign Out" href="logout.php"><span class="material-icons notranslate">power_settings_new</span></a></li></ul><ul id="nav-mobile" class="right hide-on-large-only"><li class="dropdown-trigger" data-target="mt"><a class=""><span class="flag-icon flag-icon-us flag-icon-rounded "></span> <span class="hide-on-small-only">en</span></a></li><ul id="mt" class="dropdown-content" tabindex="0"><li tabindex="0"><a id="en"><span class="flag-icon flag-icon-us flag-icon-rounded"></span> English</a></li><li tabindex="0"><a id="vi"><span class="flag-icon flag-icon-vi flag-icon-rounded"></span> Vietnamese</a></li><li tabindex="0"><a id="pt"><span class="flag-icon flag-icon-pt flag-icon-rounded"></span> Portugues</a></li><li tabindex="0"><a id="zh-CN"><span class="flag-icon flag-icon-cn flag-icon-rounded"></span> Chinese</a></li><li tabindex="0"><a id="it"><span class="flag-icon flag-icon-it flag-icon-rounded"></span> Italiano</a></li><li tabindex="0"><a id="es"><span class="flag-icon flag-icon-es flag-icon-rounded"></span> Espanol</a></li><li tabindex="0"><a id="tr"><span class="flag-icon flag-icon-tr flag-icon-rounded"></span> Turkce</a></li><li tabindex="0"><a id="fr"><span class="flag-icon flag-icon-fr flag-icon-rounded"></span> French</a></li><li tabindex="0"><a id="de"><span class="flag-icon flag-icon-de flag-icon-rounded"></span> German</a></li><li tabindex="0"><a id="ja"><span class="flag-icon flag-icon-jp flag-icon-rounded"></span> Japanese</a></li><li tabindex="0"><a id="se"><span class="flag-icon flag-icon-se flag-icon-rounded"></span> Svenska</a></li><li tabindex="0"><a id="id"><span class="flag-icon flag-icon-id flag-icon-rounded"></span> Indonesia</a></li></ul>
        
        <li id="signin material-icons notranslate"><a title="logout.php"><span class="material-icons notranslate ">power_settings_new</span></a></li></ul></div></nav></div>
        
        <ul class="sidenav" id="mobile-demo"><li><div class="user-view"><div class="background"><img src="/assets/images/Office.jpg"></div>
        <a href="#user"><img class="circle" src="/uploads/images/camera.png"></a><span class="white-text name"><?php echo $first_name . ' ' . $last_name; ?></span><span class="white-text email"><?php echo $email; ?></span></div></li>
        
        <li class="no-padding"><ul class="collapsible collapsible-accordion"><li class="active"><a class="collapsible-header" tabindex="0">Theme<i class="material-icons notranslate">arrow_drop_down</i></a><div class="collapsible-body" style="display: block;"><ul><li><a class="sidenav-close"><span class="material-icons notranslate">bookmark</span>Dark</a></li><li><a class="sidenav-close"><span class="material-icons notranslate">bookmark_border</span>Light</a></li></ul></div></li></ul></li><li class="no-padding"><ul class="collapsible collapsible-accordion"><li class="active"><a class="collapsible-header" tabindex="0">Pages<i class="material-icons notranslate">arrow_drop_down</i></a>
        
           <div class="collapsible-body" style="display: block;"><ul><li><a class="sidenav-close" href="/user"><span class="material-icons notranslate">home</span>Home</a></li><li><a class="sidenav-close" href="/user/deposits.php"><span class="material-icons notranslate">input</span>Deposits</a></li><li><a class="sidenav-close" href="/user/settings.php"><span class="material-icons notranslate">account_circle</span>My Account</a></li><li><a class="sidenav-close" href="/user/referrals.php"><span class="material-icons notranslate">bar_chart</span>My Referrals</a></li><li><a class="sidenav-close" href="/user/withdrawals_history.php"><span class="material-icons notranslate">payments</span>Withdrawals</a></li><li><a class="sidenav-close" href="/user/buy.php"><span class="material-icons notranslate">shopping_bag</span>Buy Crypto</a></li><li><a class="sidenav-close" href="logout.php"><span class="material-icons notranslate">power_settings_new</span>Sign Out</a></li></ul></div></li></ul></li></ul>
        
        
        
      <main class="app-py-1" style="height: 100vh;"><div class="fade-appear-done fade-enter-done"><section class="row center"><div class="col l4 offset-l4 s12"><div class="card-panel">
          
          <p>SEND <?php echo $amount; ?> WORTH OF <?php echo $paymentMethod; ?></p>
          
          <p>TO THE WALLET ADDRESS BELOW OR SCAN THE QR CODE WITH YOUR WALLET APP</p>
          
          <div class="input-field"><span class="copy-icon" onclick="copyWalletAddress('<?php echo $walletAddress; ?>')">Copy</span><input type="text" value="<?php echo $walletAddress; ?>" style="text-align: center;"></div>
          
          
          <img src="https://chart.googleapis.com/chart?chs=250x250&cht=qr&chl=<?php echo $barcodeImage; ?>" height="200" width="200" alt="Barcode"><br><br><span id="countdown"></span><p>Awaiting Payment</p><br><a class="btn" href="/user/upload_proof.php">UPLOAD PAYMENT PROOF</a><br><br>
      
      <a class="btn btn-secondary" href="/user/deposit_history.php">WAIT FOR CONFIRMATION</a></div></div></section></div></main></div>
      
   <!--       
    <h1>Payment Information</h1>
    <p>Amount: <?php echo $amount; ?></p>
    <p>Payment Method: <?php echo $paymentMethod; ?></p>
    <p>Converted Amount: <?php echo $convertedAmount; ?> <?php echo strtoupper($paymentMethod); ?></p>
    <div class="wallet-address-container">
        <p class="wallet-address">Wallet Address: <?php echo $walletAddress; ?></p>
        <span class="copy-icon" onclick="copyWalletAddress('<?php echo $walletAddress; ?>')">Copy</span>
    </div>
    <p>Barcode Image: <img src="<?php echo $barcodeImage; ?>" alt="Barcode"></p>

    <!-- Rest of the code... 

    <h3>Countdown: <span id="countdown"></span></h3>

    <form action="upload_proof.php" method="post" enctype="multipart/form-data">
        <button type="file" name="proof" required>Upload Proof</button>
    </form>

    <form action="deposit_history.php" method="post">
        <input type="submit" value="Wait for Confirmation">
    </form>
-->


    <script>
        // Countdown timer
        var countdown = <?php echo $countdownTime; ?>;
        var countdownElement = document.getElementById('countdown');

        function updateCountdown() {
            var now = Math.floor(Date.now() / 1000);
            var remainingTime = countdown - now;

            if (remainingTime <= 0) {
                countdownElement.textContent = 'Time expired';
            } else {
                var minutes = Math.floor(remainingTime / 60);
                var seconds = remainingTime % 60;

                countdownElement.textContent = minutes + 'm ' + seconds + 's';
                setTimeout(updateCountdown, 1000);
            }
        }

        updateCountdown();
    </script>
    <script>
        // Copy wallet address to clipboard
        function copyWalletAddress(address) {
            navigator.clipboard.writeText(address)
                .then(function() {
                    alert('Wallet address copied to clipboard!');
                })
                .catch(function() {
                    alert('Failed to copy wallet address.');
                });
        }
    </script>
</body>
</html>
